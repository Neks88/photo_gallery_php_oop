<?php 
require_once ("login_template.php");
//Database Connection Constants


define('DB_HOST','localhost');
define('DB_USER','root');
define('DB_PASS','');
define('DB_NAME','gallery_db');

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// DATABASE///////////////////////


class Database {
  
  public $connection;
  
  function __construct() {
   $this-> open_db_connection ();
  }
  
  
  public function open_db_connection () {
    $this->connection = new mysqli(DB_HOST,DB_USER,DB_PASS,DB_NAME);
    
    if($this->connection->connect_errno) {
      die ("Database connection failed badly". mysqli_error());
    }
    
  }
  
  
  
  public function query ($sql) {
    $result = mysqli_query ($this->connection, $sql);
      
    return $result;
  }
  
  
  private function confirm_query($result) {
    if (!$result) {
        
        die ("Query Failed");
      }
  }
  
  
  public function escape_string($string) {
    $escaped_string = mysqli_real_escape_string ($this->connection,$string);
    return $escaped_string;
  }
  
  
  
  
  
  
}

$database = new Database();



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////USER CLASS///////////////////////////////////////////////////////////////////////////////


class User {
  
  public $id;
  public $username;
  public $password;
  public $first_name;
  public $last_name;
  
  
  
  
  
  
  public static function find_all_users () {
  return self::find_this_query("SELECT * FROM users");
  }
  
  
  
  
  public static function find_user_by_id ($user_id) {
    global $database;
    
    $the_result_array = self::find_this_query("SELECT * FROM users WHERE id='$user_id' LIMIT 1");
    
    return !empty($the_result_array)? array_shift($the_result_array) : false;

  }

  
  
  
  public static function find_this_query ($sql) {
    global $database;
    
    $result_set = $database->query($sql);
    $the_object_array=array();
    
    while($row=mysqli_fetch_array($result_set)) {
      $the_object_array[]= self::instantiation ($row);
      
    }
    return $the_object_array;
  }
  
  
  
  
  
  
  public static function verify_user ($username,$password) {
    global $database;
    
    $username = $database->escape_string($username);
    $password = $database->escape_string($password);
    $sql = "SELECT * FROM users WHERE ";
    $sql .= "username='{$username}' AND password='{$password}' ";
    $sql .= "LIMIT 1";
    
    $the_result_array = self::find_this_query($sql);
    
    return !empty($the_result_array)? array_shift($the_result_array) : false;
    
  }
  
  
  
  
  
  
  
  
  public static function instantiation ($the_record) {
    
      $the_object = new self;
    
//          $the_object->id = $found_user['id'];
//          $the_object->username = $found_user['username'];
//          $the_object->password = $found_user['password'];
//          $the_object->first_name = $found_user['first_name'];
//          $the_object->last_name = $found_user['last_name'];
    
    foreach ($the_record as $the_attribute=>$value){
      if($the_object->has_the_attribute($the_attribute)) {
        $the_object->$the_attribute = $value;
        
      }
    }
      return $the_object;
    
    
  }
  
  
  private function has_the_attribute($the_attribute) {
    $object_properties = get_object_vars($this);
    
    
   return array_key_exists($the_attribute,$object_properties);
  }
  
  
  
  
  
    
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////FUNCTIONS//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




function __autoload($class) {
  $class= strtolower($class);
  $the_path = "includes/{$class}.php";
  
  
  
  if(file_exists($the_path)){
    require_once($the_path);
  }else {
    die("This file name {$class}.php was not found...");
  }
}

function redirect ($location) {
  header("Location: {$location}");
}





/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////SESSION////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


class Session {
  
    private $signed_id=false;
    public $user_id;

  function __construct () {
    session_start();
    $this->check_the_login();
}

  
  public function is_signed_in() {
    return $this->signed_in;
  }
  
  public function login ($user) {
    if($user) {
      $this->user_id = $_SESSION['user_id'] = $user->id;
      $this->signed_in = true;
    }
  }
  
  public function logout () {
    unset($_SESSION['user_id']);
    unset($this->user_id);
    $this->signed_in = false;
  }
  
  
  
  
  private function check_the_login () {
    if(isset($_SESSION['user_id'])) {
      $this->user_id=$_SESSION['user_id'];
      $this->signed_id =true;
    }else {
      unset($this->user_id);
      $this->signed_in=false;
    }
  }
  
  
  
  
  
  
}
  
  $session = new Session();
  


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////LOGIN.php////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//if ($session->is_signed_in()) {
//  redirect("../admin.php");
//}
//
//
//if(isset($_POST['submit'])) {
//  
//  $username = trim($_POST['username']);
//  $password = trim($_POST['password']);
//  
//  //Method to check database user
//  
//  $user_found = User::verify_user($username,$password);
//
//  
//  if($user_found) {
//    
//    $session->login($user_found);
//    redirect("../admin.php");
//  }else {
//    $the_message= "Your password or username are incorrect";
//  }
//  
//} else {
//  $username="";
//  $password="";
//}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//require_once ("login_template.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////LOGOUT////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



?>